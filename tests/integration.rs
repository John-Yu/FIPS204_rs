mod nist_vectors;

use fips204_rs::{KeyGen, MlDsa44, SerDes, Signer, Verifier};

#[cfg(all(feature = "default-rng"))]
use rand_core::RngCore;

use rand_chacha::rand_core::SeedableRng;

// $ cargo test --package fips204 --test integration forever -- --ignored --nocapture
#[cfg(feature = "default-rng")]
#[test]
fn forever() {
    let mut msg = [0u8; 32];
    let mut i = 0u64;
    let mut rng = rand_chacha::ChaCha8Rng::seed_from_u64(123);
    let mut flip = [0u8; 5];
    loop {
        rng.fill_bytes(&mut msg);
        let (pk, sk) = MlDsa44::try_keygen_with_rng(&mut rng).unwrap();
        let sig = sk.try_sign(&msg, &[0]).unwrap();
        let ver = pk.verify(&msg, &sig, &[0]);
        assert!(ver);
        // now, confirm that we do not accept an invalid signature
        rng.fill_bytes(&mut flip);
        let index = u32::from_le_bytes(flip[0..4].try_into().unwrap()); // index of byte to flip
        let mut sig2 = core::array::from_fn(|i| sig[i]);
        sig2[index as usize % (sig2.len() - 2)] ^= if flip[4] != 0 { flip[4] } else { 0x55 }; // investigate sig[last]
        let ver = pk.verify(&msg, &sig2, &[0]);
        if ver {
            eprintln!("Msg is      {}\n", hex::encode(msg));
            eprintln!("Index is {}\nflip[4] is{}\n", index, flip[4]);
            eprintln!("sk is       {}\n", hex::encode(sk.into_bytes()));
            eprintln!("pk is       {}\n", hex::encode(pk.into_bytes()));
            eprintln!("good sig is {}\n", hex::encode(sig));
            eprintln!("bad sig is  {}\n", hex::encode(sig2));
            assert!(!ver); // fail and stop if 'verified'
        }
        i += 1;
        if i % 100 == 0 {
            println!("So far i: {}", i);
            break;
        };
    }
}

// This test originally demonstrated in **draft** FIPS 204 that two different signatures can be
// verified for the same pk/sig. However, it now demonstrates for **released** FIPS 204 that this
// problem is now fixed.
// Spec error, see https://groups.google.com/a/list.nist.gov/g/pqc-forum/c/TQo-qFbBO1A/m/YcYKjMblAAAJ
// Ref https://github.com/pq-crystals/dilithium/blob/master/ref/packing.c
#[allow(deprecated)] // _internal_verify()
#[test]
fn bad_sig() {
    let msg: [u8; 32] = <[u8; 32]>::try_from(
        hex::decode("2e77de619a8963d1ec5ff9e7db269e3ed9076a35badf49960571c8a98055d8eb").unwrap(),
    )
    .unwrap();
    let sk = <MlDsa44 as KeyGen>::PrivateKey::try_from_bytes(&<[u8; 2560]>::try_from(hex::decode("6ef73b20d211607012d7697a8277141e905239801f7bd539cbb8ea8e3d9146a515bbd2e28754acdf3ca5a9a17feaa3c0b336a365aa3e02f02c438845823b6be5d63f8b5e3deec3a297b3906f3b5f094da7bb165acaa37ab4dbdb2a1f63198910ee9212a21feaa334a02b3875a03fd1b78ed68a03595303d0c3e8b9a7808512af0c037193884812396153401289b410102548db1065d2c66959b8301411910c2522c3b44908250940c285a1c004d2360522c100cc12299848412105881a49700449302202104c822c23a96820a185dc006a0bc68c21354cd8801020416c8316660b310ae2b66c121024d2c6718b246401c60c8b266401895110996d22a00d042920202069518404ca2682d9128c1b026084c85158b051831086123328484622ca841184264e21c6600a070d58306419016d21380c1b266d99b4855c0651d0187142286e24a4842182459aa80c50b685a310615ba001c096008ac071c0a04050a200124246513030d4384ac9286110265023a240502682c0900902114602a92889b210db324190342813c78dd2204d19a52521b97188902123362212178d6414690033481ac481d294405a300dc914650cb129c1422d43c4615396299c302109c26c09426021968920b490219485da3681c3b80943142149086543848d93088c00954413076a40304ada806580343223968161c644e0285120058892048522158858068a40241042b86508166c89c884a01430ca9051d04289449688e1b061181000503282484648e1280e8a12491a3845a23880e238529c048dd3362112060114a71110094519a72c0128681ba92d218625a41809c4b62493105158126150c86d9306425cb685db982819306e23b10da42204d1b800da4866ca124489460ec8144963462d912864990686093810134000128865144628042429dac844a320284c9691e204224290114aa664c0482d0129500aa96c60a2044a124251c20402276d43b211000680e44012cb268a03c30851042249326991308e61064a0c346621900450b84119430609362e01344c1a386d0b898c11a2600208091b3128193811db1032d1840d4b4286d4b271dc066c00326008412888981109b180ca206824016510324a21936589b26d82a8440c893144b610128321a31285d2422a89321018442804a82959842941c201094782d0a02562226ccb18245208121a130008a040a10602e4a66514134094008a8c360ec9a089610640210241d3028013316dd206029b51781ac3a5960cb8833902e9f8b9e3ee16565ea0f7ff99bf78e1615a6c13e255c493ff1e0f4470ffb3726cab9209301832c2f499c158cd5bf40ddcd3c9ce7c659e660ee05740b169199ff1c866f7019ab53379481a8d3fe35356600e650de1dbfd9a42a1362af0b45d0d483fe2f427f303ba6296d05dd779babfb8d00d3acb24a2de06382cfad42b58fc1ff641d37cd2a43a3eace737e3e84732ee0d1109482d2cc4b22f38ca7f32ee16828ad732523edb39f0446ac568cbf166e9b31147dbd5db72f0b8c0e4d2a81606e9857c81bde135c431bcf489c8342d8c586493c52cb98a845f765dee285a1c48fb610312ebdb731464cca484e733b3cc333c208d9538416ea9dafe8d997016e3a724bfd6b00680e541613f5d3efc23b7e94a7ce71b1918ee78cb0d856c804b107ecc55541b2696958de0d06e030a6002eaff42b0e8ab7b64fd6592e42c582480ec539e286d3298e429f33e40fc8924ed70140a931f60afa9f81084578ccda3f6edf568f48cc8d6ef01d8875f9530793fd8bd099be129c14abdd7d5930a16aa317a4d40d2c22b6ff4fbb4e6d261206d4333c321911df41892109d412c5aed2299e4688113000eaab6a86e07c5979a251f44dbd2d45dc313adcc632d5f59da19dba7c4bcd17b40f7f96bfc49c6959155400d64fa53c2268c1a6b1ee5f630e9146e75e2ce1045af964127b2d29ba232cbffb7067f10b18880ce635e3d0e4c6f27430a34875a206623a08761d48519c53d9d68464f4687322020fa06b5d63d87e97a556271b1af1d7e7ae2db32d80bcf5fd09d9c283e3d28e29602dacb99ae56db9f7bc4b3b7247328d4b70497470c58e8b6f9154c2e87b2d92800bd17ea2b71c5239d55aa15d0a6e6efb67890ed272ebf69edcba8574fd788f57fe62141ea584219ac3cc926121f7fcbe46589f7e3f76c02f499b2c271ec3af1e43470243c52cdaac42e123900a832b175dda043295ff13af0239da5c724d30442a17d89ef07f8eaf9c16e6506f63eaf0995a9e103635e6052126ecb2774bc745619396e0eecb9cc00a4b35b094316653fa86995724350b90440e077c1523acdf980c2b29d4e54cbca6948c065e36eb08517be32a0f591e0d4887aba99097d75a97b2e14686b9e725752b75a7c312af0a3dff4222dee6ce015b56799829dcbc43b1e12ec97b354515558b22066afd8e1a6316f75598cc9f347eb120fc47cec2d750c411eddfd0df24fa1fe5e05e65eacab1536455540c5353a6fccb4ae6f86e3ca967d181942e8213684a8aac9d528de027fd984e7ded3a84458b4270abc847be85f9a3fd736f3c3cdb3b0f18cf0e793f331227989ff0ed0415e22feeee0b9800b29af84ff06e920b6e7fcb758f8733fe444c5a6f9b55c9e8b5eb0185da1bd08c25dfdd4e427a29eacfbc3a5da364759fd8f9c71afeff42e5dbe1432aefcffb727d55b67d7f61d9b8f52db5e9caf946d594d7cf2a1a55422a9e5700074219b0c3045ef572e60318ef3e7ae8dd7b821d07d7df54a563458c6dec05dfff6fcd462ae26caca3323bdc1929bcb4723c8a78d24a5b135167b4602b97902968bd5aa58fb798d8b92f31bbdf3ac3fab6f87926989acc9443fe5c7ea4f8f54bdad5f138eb0b75826837836e33915d95347bb69090cb774a26ef15cda81ca98cfe0cec911d85e70745877e563f17f43322b0b8995840491f197a58a3dc76f95695ff10d48286bc2755337eb1dad68b7371c52b8f491bc6e751a6347f8fbe429c65e33668467ae0dac3f4dd28ebeb5c5aecb1eb478e7a70a1a14ef1190d2843c0b992f5d8b0134d34016e153167e731e85280a36338b8df0477d46b747000d2b168be6dbcf2f138063cc15014357173c6e1674bae16be57ea7043aa6bae0c67d8caf801d7ce0055bb8c4bd52c5010be6dd6c28287c1f88391faeb19917af085f724c48c23b120d70bc9ae4ce292ef97f099cfae69eef756ca50e0dbf8486ac04c400b3188756c9d7ed3422fd3170dce3f66d6b90858159ae64f8b30b73fad255d0214f550b337306f02b16e96c18d1426e31bbc46180893908b0d3773c0699eb60fcf236b480fb665c573e0abd59e113e3ba295a94cf95879aa8373af97ae9a90298c218b95807a8e799b194b68aed731146bab58fa5494b42ef9acb7181e82bc3225b1f00dd79ee40897402cbeac266954a0dfa24406c686a922e65defc7e0f131e58c892df216c6b96a088199984bb4410f9ef1eef8c1cc2c05501072c2a674ff8fb7bffdfd0ccaeb66f77d897e3c5b1adfe5f79ec5e94c12ef097da5c4393d165e84a9b69f53661670bde2663d7b99d3713fbfef511710141798837dab0d153fc").unwrap()).unwrap()).unwrap();
    let pk = <MlDsa44 as KeyGen>::PublicKey::try_from_bytes(&<[u8; 1312]>::try_from(hex::decode("6ef73b20d211607012d7697a8277141e905239801f7bd539cbb8ea8e3d9146a5035af8ef22935f07f254a03558b8aa3b7baff5d1d0c63890beebfa28b13c67954696229413467a676b4611a7d9f0edefe78b7d70db79dbfb31df0dda9d81906af3295a285ed27288e00badf22724be26a3a6e3f00bb1f8671777b5eeca11fb6432969d38a8e8022548ee39b26bafc2071f26a1f0f602c8451b37e1c170494fba123b6f5a789e71f005fc0b1c4209b99cc9780b6b4ce4cfcf26ab3c8cb3991b0e516ae6ece41c1ad81432cb50112e59bc66e67d3f6e88dd80f91a319a5237064ec463ea5023780a480760a1c110816b1348e15ac2e8bc10ce0a2d8b47da53d8b3ab8ffa4fde0fb861d05a582492998f0d60d45a95885d1d4e5b3bfca1c7d9fba9b11f99d7f3087ae8891c6a1f5cfd3a02d4fe8e1c510ef023574c0dfab9f86a7e8491b405c659ba84eaf6b2b5d1eb4db575d0d25bd6e92f43a80dad5725b8847dfea0ee18e2222000d738210accfc75d3718f78eaeb9f2964688276c8269fd8803c5854eda05efed36cf4e57dbf4b54bd18db022e4494812644353818eb2f5509e14f8a3c682dea883deec5bf0ac75b7c893ab14c01c3336987b718b92dc6ec34a8278dc5a0981e8162fb822cfb86ce283cf22145f701623d1aaa36c653463b373a07fcecadfdf24287bc2213b43108550c505160b14f68ec36bd94bfcc372e82c3bb5044126b76541e0776e874de03c4eade5cc42bed862f7b30ced6da5cdb09d761a848bce989cd7219929fac382266d49268a542a6484b8d29b5423ff28d18d5d052a751cef7d4f550b68b01bdb510aea11cfd314489f522d8f6273f3612e9f49b459819c1ff19c9f38f17cc0a8934612a52df3ce09d807caa2414c449efe8c9a90697fcc48607d344bc1f4140c4a159a8e1ecb13b9396e74f379f7f4da69a2d20cde7c3f360f4c2afe140a4ffed050dd0ca6851b4c6e8c959e8ace271afd3ee880367a1c862a47f5cfc95f07e970766c00cc45b7d6060b48110fe8dec28793d1a3cb784d16ea82ab39ea01a7cc86028c98589586a11d3b0ab468cb160ddc7a70cd9b8214b9fe54c6d7d69dbc8e1efeae24a8985fae533737d2156aa5c3d78f50209d2039566d98aa1ee442a738a53fd004f4e464734793d4a24d6bb3a76f0dac5cff75417c5f89d9abaad89994e420add0d6c0f7ec7910b46bf758e71e1fbe598a1dfd746ba15f6ef8e5135b6f3cf03f9c36981ed6b6cbba00f881dc1f929101ca774af1c89d2fd96e713609740b74592758e70b23c8f7ee774564d9654974c783fadb0589858f1f70a9294e84fd19db1cd43d7034831c6eee7f6fdc2a0d4ff97ae2c6e97c44906f9ad18a393ecf346fdeb0c4aeb1e705d3b699bedb5ae435f28ae4ef1e35220bf90c58afeb1aa26fa215b35ad0ee32ff8422f8943feb2887a9f094acf13df4bb2666e7f5463f9ed7129279e31d73ae000208aded4fd233eb837ee0b70dae358965651df6ddb9181b1b820eb86e78cfca93d682d47e78eeb09782dae582b359a78e7746c3f81a15ab8a325b848c64336790baafe0fb6045312e1168b62b58dcc89f54972426d3ef542040de0dcfd67534356cef46ab464e580d89c73ceebf3bd79229d7a669eb96dc76808924693a948d60dc6c377aaaa7f5769aa051777082cd0821e95c5647e53eb889830bb6c15dc7374da7726e14d14e82985122295c6dfc1ba7266b0d108561f58eb183ef8f7c7c247c11a229ac8f7ed989c78855b8bd949de7f94762e1f692f373880115b8faa9558dca7abbd36ff1a64f35853a79f447d9381a7b93b4c43fb8b4152d884a7d319508bccc3a21b2d").unwrap()).unwrap()).unwrap();
    let good_sig =<[u8; 2420]>::try_from(hex::decode("bcb502b1c16c3bf5c40450fd32ec0d15f5d31e454716984b76cef27ff5bd3e4d11f80cf857d677a984bcb70f29915840ecce898914a65d33a425417308afc2fb247428a5ed843d0603469973172102ecf997fdfeaeab39b41ee3be5afd4157e1dc34ce9b782aef95edacdfcecab116315a925bdb0c17fec880052804efcad89a0cea15e76e9ad8de73002bb6e6d6bb182dbb16c6b4714e07f5c130656cd253d5711c446871bf02a3a28f90a3b1f26e8d6116afce733986563fc6c0c1f4ff4c8a86f5f49d7a949b38ba2351fd38ac6a33996c6ea818ba0830dd004f90ceeeb1f4bcadd3a28d9baa8c3ea7c3b12c478553ff9d323bc2e480528941714ca59f08da5e870ea30bda4ffa9ac194bdba21cb9e08502d400b810d12534b8a4476ae3a48a0e8cde465f6bd0bbc25b9668e6753464aef17d5cc84f9107856f379ec42cf762224090d91f2d0b26721b56182a2150d24b766f5735d37cc594965c9a02462231891ea1f37849313dfc3af65d2b24b510caa689e912be1bc49011aea6276459d52a4b2a7ad00cf27f73e830ae02c051ab868533fb0f08b189123b60acd5bfd4719dc15a4d07a118b25f53cc20b10d26af2ade3e4593e47ce4729f20a1762f5baeebe8de435f237c248bd9530ade80627c6414bcd80edb35bb23efafd82c10ddc4733e76a1e5a5173ef4ee1988060994c50b3aceff0740a319d7b9e1c9241e6a49cf25109015de1cdaa7a5f89dd7be7174a153e906648ec3e567d104d352d34cebed293cef06ef551b46a1f1516ffa54827829ecfeba79853ea850ba67c74e694f1d2f7195a7568b61f576997cf3e409f51a67020f446981dc8bace88424739938a40c21165e0a2b94f51ffb39bb82bfb62533f62d0ceec50aef1ad079478c3c45ed6ee7d608e1d0f29b605da0c55cfea0ba40d4e8499872fa445da3cee7ae8b8ec62ec20ff158b70243a350d59de0c2e69254fe7a1ca825686c0c81a9c3ea1129d9f97395c9fd91ba5c996a510bf3a87dd2ed57cbc717aeb3e218dc1f28558709d9a88d4f6dea89ab69a61eb84515a9ef1577c2c57673bdd462d26ab30b306ac4101e3e05af0915b0cbbf4743ba0107149fc8576738e42005eb7978f2d753e2adb4839a8335fb48a8bdeef60bbb5cb44f54b8624d2365d5b92d159c7227116a87100bb1a2e3394124149a32c859c0a9f30371f80d048c02f154d14bf1b37b1db32c701c51397faa880483c90b01aa61d50b5f148c3326d569e2fcde732f8d6bd1f439add3fff31ab158aad4bd13bcecce77ff7bd46c277766a8404582b55cf9e67088ba7040e459844e821e60bc9db11c65083baf60d7bcea45e9e121b52f4f72ec142ec691ba61ade30255d1379c61182da55416e2d8e60f5cb1e9801bf7b1805a6542213da0311fa7aa078d94c86909f5358209ecb9d07129cedad0031012df076fcb03120a6276563711fea05964ddbbf09a1badb0a93b1ec60be62159b669c0623d9242c3d03bf29047de26e92d3ba300ca2fab5859e59e37542454141589ebf8e823fd8a08470951bc2db82de8b72fa839a483b7f7326cdea03246588ee10993a6962f8e07f4765b063d89d48d49ad5de307df0de6b5b8574d40a190adf709776aac04dd3c6f531f96d07c2186eb9d0e7418f6777a42323e144202392a664f938601bfa0aa028d7f5835e6811d7efea967bbcd9db824365eda0988ea1002d28939d0e3f66ebb41daa20ab33b728771ab422a8beb8571828947601fe833feea78c393b36c75880b1f0d4f9efeb268ed03cdb0e81e8139f578495e6ea6e55dbe0b8c661f1c013b14540bff775f6b095c03dffacb8534161aa8e10362d6eb3f5622ab5ef1203f03e9a141f5f54fe8e8dbdb403fcf399558baf8154a9d74e2f2033eed030b38980066b45f71854565f239df1bfbc773e991d033862b59f2ac5ccb932f0178a08669f56c07593bd11c4612a6ef4aeaa4f7532cbdb6604c659764d5a574602ba5c344c470eb29303b89955df5bcce7f7ab7b7ba8da332f30d5444111731e988d597bfb1928f4eda9ad1ca3c9c56d70bbaa4e47be0a386b4de060ba4538ec7db8a617a35252c6b121cf9e1910ea6385943263b1b18224746e421687648fb598f9a9e9aba59bea2a208d6b98c33d8268c5d2370d2eb354a66ba7ff6c35633fcd5614f71c68b56859e37983316fd99794684365d0ce167f891c1393c3f016c3293f16879d00c65ed86ad7684c825d87a853767149c8c7aead44f63e5a425134f6f6823a1f7825143d51b89bc8e077b174e5d1ae41815ad3f80c0dd27d4c6358ed4441eb89b8027b0b2cd3f700c1934b4410ef714ee8c54aaae4562d14f4bbe9f3b60bf07d547e25a8145b302e3e32731a68a106d4289cb1298fae0e6709ffb855d9673bd41e3459bc5c2df3b218d44cce81759a5a5cee8ba755a1dcdfd3e264c38bdf475ef6221b6a684987aace346e3b4d70ba4c5591682032fe0b20df05f54ea3c83289860cc73be8c8296fc1addd0195b9be04f3f531f035429eb38b8f58d9ad1f715a78702224e711d3b36d863721e5799d79e56785d0220e77cb3fa21062b68eeccd6abb9cea936fc517b153789d7a1fecbaaaf7ed116f032558aa813716574f550edfe3687424f67596a04916a591bfbb05b24d778de7d880ad711ca3162128f65d71ba8609bb931c19dfd38ea341fd25aca1f0169816258361e8b49b053fa203b8fb5c86c1d5bb0190d59040cf145b0ddcd27c5361a28850bd2c8181b4e72063832a38e200f98fdd54bb77ad685daffc31d27d8fc2fc374d437510f077cc278e7305b10f076e8a01dca35d3d1d54966a74c49a4c6ea168d6ebb8f07c3b8b6122edc4a1b642e6fb7b6e4b529ec743d63da129a889347e7c4b1109c4419bf13fb1cab50b6229015466175cb57b577b399bca25a0b784f99f90317082949b01e518a6d4348dc00ed76d57253ee6959b01c6fd89d1f006d9cb1e08b70fcb5ddc4b5b531989e3a2d1544b6041eaba1375fbcf8b756020b10ebeeb24e349f75ccfdd2c2eec5183e12a9a4daa677ca7b138185e3fa5a54f30df049ca4065ca928d07bc337f6383852291e12273800a3e9e492b5219cc25e021d91b5be483c8c1066c254ca3a28aef1de15dac4adcf425bebae41ea47788e8aa9d461b35a5d157073b68a155a609077ed9cabf1a1683a26f789afa7c104f321676225c438901aa0dd7719d43d89faf4b92785d0d63ebb4a1f91c66868dc5ccea9c9fffa80c5c111d77000f33865b17f12ce08c64f35708756f28b1025ca0f0ea2b29228393f4144546264717e8589c2c3d7ddedf4040b0d6a829ea5d2ddfd16376f70a0b0b1b3b8bccccdcee1fb0031438ca3a9cb000000000000000000000000000000000000000000000000000000000000121c2b32").unwrap()).unwrap();
    let bad_sig = <[u8; 2420]>::try_from(hex::decode("bcb502b1c16c3bf5c40450fd32ec0d15f5d31e454716984b76cef27ff5bd3e4d11f80cf857d677a984bcb70f29915840ecce898914a65d33a425417308afc2fb247428a5ed843d0603469973172102ecf997fdfeaeab39b41ee3be5afd4157e1dc34ce9b782aef95edacdfcecab116315a925bdb0c17fec880052804efcad89a0cea15e76e9ad8de73002bb6e6d6bb182dbb16c6b4714e07f5c130656cd253d5711c446871bf02a3a28f90a3b1f26e8d6116afce733986563fc6c0c1f4ff4c8a86f5f49d7a949b38ba2351fd38ac6a33996c6ea818ba0830dd004f90ceeeb1f4bcadd3a28d9baa8c3ea7c3b12c478553ff9d323bc2e480528941714ca59f08da5e870ea30bda4ffa9ac194bdba21cb9e08502d400b810d12534b8a4476ae3a48a0e8cde465f6bd0bbc25b9668e6753464aef17d5cc84f9107856f379ec42cf762224090d91f2d0b26721b56182a2150d24b766f5735d37cc594965c9a02462231891ea1f37849313dfc3af65d2b24b510caa689e912be1bc49011aea6276459d52a4b2a7ad00cf27f73e830ae02c051ab868533fb0f08b189123b60acd5bfd4719dc15a4d07a118b25f53cc20b10d26af2ade3e4593e47ce4729f20a1762f5baeebe8de435f237c248bd9530ade80627c6414bcd80edb35bb23efafd82c10ddc4733e76a1e5a5173ef4ee1988060994c50b3aceff0740a319d7b9e1c9241e6a49cf25109015de1cdaa7a5f89dd7be7174a153e906648ec3e567d104d352d34cebed293cef06ef551b46a1f1516ffa54827829ecfeba79853ea850ba67c74e694f1d2f7195a7568b61f576997cf3e409f51a67020f446981dc8bace88424739938a40c21165e0a2b94f51ffb39bb82bfb62533f62d0ceec50aef1ad079478c3c45ed6ee7d608e1d0f29b605da0c55cfea0ba40d4e8499872fa445da3cee7ae8b8ec62ec20ff158b70243a350d59de0c2e69254fe7a1ca825686c0c81a9c3ea1129d9f97395c9fd91ba5c996a510bf3a87dd2ed57cbc717aeb3e218dc1f28558709d9a88d4f6dea89ab69a61eb84515a9ef1577c2c57673bdd462d26ab30b306ac4101e3e05af0915b0cbbf4743ba0107149fc8576738e42005eb7978f2d753e2adb4839a8335fb48a8bdeef60bbb5cb44f54b8624d2365d5b92d159c7227116a87100bb1a2e3394124149a32c859c0a9f30371f80d048c02f154d14bf1b37b1db32c701c51397faa880483c90b01aa61d50b5f148c3326d569e2fcde732f8d6bd1f439add3fff31ab158aad4bd13bcecce77ff7bd46c277766a8404582b55cf9e67088ba7040e459844e821e60bc9db11c65083baf60d7bcea45e9e121b52f4f72ec142ec691ba61ade30255d1379c61182da55416e2d8e60f5cb1e9801bf7b1805a6542213da0311fa7aa078d94c86909f5358209ecb9d07129cedad0031012df076fcb03120a6276563711fea05964ddbbf09a1badb0a93b1ec60be62159b669c0623d9242c3d03bf29047de26e92d3ba300ca2fab5859e59e37542454141589ebf8e823fd8a08470951bc2db82de8b72fa839a483b7f7326cdea03246588ee10993a6962f8e07f4765b063d89d48d49ad5de307df0de6b5b8574d40a190adf709776aac04dd3c6f531f96d07c2186eb9d0e7418f6777a42323e144202392a664f938601bfa0aa028d7f5835e6811d7efea967bbcd9db824365eda0988ea1002d28939d0e3f66ebb41daa20ab33b728771ab422a8beb8571828947601fe833feea78c393b36c75880b1f0d4f9efeb268ed03cdb0e81e8139f578495e6ea6e55dbe0b8c661f1c013b14540bff775f6b095c03dffacb8534161aa8e10362d6eb3f5622ab5ef1203f03e9a141f5f54fe8e8dbdb403fcf399558baf8154a9d74e2f2033eed030b38980066b45f71854565f239df1bfbc773e991d033862b59f2ac5ccb932f0178a08669f56c07593bd11c4612a6ef4aeaa4f7532cbdb6604c659764d5a574602ba5c344c470eb29303b89955df5bcce7f7ab7b7ba8da332f30d5444111731e988d597bfb1928f4eda9ad1ca3c9c56d70bbaa4e47be0a386b4de060ba4538ec7db8a617a35252c6b121cf9e1910ea6385943263b1b18224746e421687648fb598f9a9e9aba59bea2a208d6b98c33d8268c5d2370d2eb354a66ba7ff6c35633fcd5614f71c68b56859e37983316fd99794684365d0ce167f891c1393c3f016c3293f16879d00c65ed86ad7684c825d87a853767149c8c7aead44f63e5a425134f6f6823a1f7825143d51b89bc8e077b174e5d1ae41815ad3f80c0dd27d4c6358ed4441eb89b8027b0b2cd3f700c1934b4410ef714ee8c54aaae4562d14f4bbe9f3b60bf07d547e25a8145b302e3e32731a68a106d4289cb1298fae0e6709ffb855d9673bd41e3459bc5c2df3b218d44cce81759a5a5cee8ba755a1dcdfd3e264c38bdf475ef6221b6a684987aace346e3b4d70ba4c5591682032fe0b20df05f54ea3c83289860cc73be8c8296fc1addd0195b9be04f3f531f035429eb38b8f58d9ad1f715a78702224e711d3b36d863721e5799d79e56785d0220e77cb3fa21062b68eeccd6abb9cea936fc517b153789d7a1fecbaaaf7ed116f032558aa813716574f550edfe3687424f67596a04916a591bfbb05b24d778de7d880ad711ca3162128f65d71ba8609bb931c19dfd38ea341fd25aca1f0169816258361e8b49b053fa203b8fb5c86c1d5bb0190d59040cf145b0ddcd27c5361a28850bd2c8181b4e72063832a38e200f98fdd54bb77ad685daffc31d27d8fc2fc374d437510f077cc278e7305b10f076e8a01dca35d3d1d54966a74c49a4c6ea168d6ebb8f07c3b8b6122edc4a1b642e6fb7b6e4b529ec743d63da129a889347e7c4b1109c4419bf13fb1cab50b6229015466175cb57b577b399bca25a0b784f99f90317082949b01e518a6d4348dc00ed76d57253ee6959b01c6fd89d1f006d9cb1e08b70fcb5ddc4b5b531989e3a2d1544b6041eaba1375fbcf8b756020b10ebeeb24e349f75ccfdd2c2eec5183e12a9a4daa677ca7b138185e3fa5a54f30df049ca4065ca928d07bc337f6383852291e12273800a3e9e492b5219cc25e021d91b5be483c8c1066c254ca3a28aef1de15dac4adcf425bebae41ea47788e8aa9d461b35a5d157073b68a155a609077ed9cabf1a1683a26f789afa7c104f321676225c438901aa0dd7719d43d89faf4b92785d0d63ebb4a1f91c66868dc5ccea9c9fffa80c5c111d77000f33865b17f12ce08c64f35708756f28b1025ca0f0ea2b29228393f4144546264717e8589c2c3d7ddedf4040b0d6a829ea5d2ddfd16376f70a0b0b1b3b8bccccdcee1fb0031438ca3a9cb000000000000000000000000000000000000000000000000000000000000121c2b48").unwrap()).unwrap();
    assert!(MlDsa44::_internal_verify(&pk, &msg, &good_sig, &[]));
    assert!(!MlDsa44::_internal_verify(&pk, &msg, &bad_sig, &[]));
    let sig = sk.try_sign(&msg, &[0]).unwrap();
    assert!(pk.verify(&msg, &sig, &[0]));
}

#[test]
fn test_44_no_verify() {
    let msg = [0u8, 1, 2, 3, 4, 5, 6, 7];
    let mut rng = rand_chacha::ChaCha8Rng::seed_from_u64(123);
    let (pk, sk) = MlDsa44::try_keygen_with_rng(&mut rng).unwrap();
    let sig = sk.try_sign_with_rng(&mut rng, &msg, &[0]).unwrap();
    assert!(pk.verify(&msg, &sig, &[0]));

    // Bad messages
    for i in 0..8 {
        let mut msg_bad = msg;
        msg_bad[i] ^= 0x08;
        let ver = pk.verify(&msg_bad, &sig, &[0]);
        assert!(!ver)
    }

    // Bad secret key  (intriguing, byte 40 is 'k' which is allowed variance)
    for i in 0..8 {
        let mut sk_bad = sk.clone().into_bytes();
        sk_bad[70 + i * 10] ^= 0x08;
        let sk_bad = <MlDsa44 as KeyGen>::PrivateKey::try_from_bytes(&sk_bad).unwrap();
        let sig = sk_bad.try_sign_with_rng(&mut rng, &msg, &[0]).unwrap();
        let ver = pk.verify(&msg, &sig, &[0]);
        assert!(!ver)
    }

    // Bad public key
    for i in 0..8 {
        let mut pk_bad = pk.clone().into_bytes();
        pk_bad[i * 10] ^= 0x08;
        let pk_bad = <MlDsa44 as KeyGen>::PublicKey::try_from_bytes(&pk_bad).unwrap();
        let ver = pk_bad.verify(&msg, &sig, &[0]);
        assert!(!ver)
    }

    // Bad signature
    for i in 0..8 {
        let mut sig_bad = sig;
        sig_bad[i * 10] ^= 0x08;
        let ver = pk.verify(&msg, &sig_bad, &[0]);
        assert!(!ver)
    }
}

#[test]
fn test_browser_message() {
    let msg = b"asdf";
    let mut rng = rand_chacha::ChaCha8Rng::seed_from_u64(123);
    let (pk, sk) = MlDsa44::try_keygen_with_rng(&mut rng).unwrap();
    let sig = sk.try_sign_with_rng(&mut rng, msg, &[]).unwrap();
    assert!(pk.verify(msg, &sig, &[]));

    assert_eq!(sk.into_bytes(), *hex::decode("e1d8a883b4f9cadb6ec2878ab505a80fae74f653c865fd8f65e81b04567282d26b85c2fd1770043e69815d5a620973e506eee815fdb9afc57a74cfb9a1a7f4eec10f3d210c89f83d3ef743eb932cbb7599b88a9e0666efb469e3e280a3951ca7fb71af23f45421955b4b7f1924a3516736b717d85072e7669393f62ff8856af1191966a208725436920183648b206a23a100103811c834240a2402d8b2904196500912240b480ce18440d2220ec1244561c84c93188d54c051dc121213a2052419055b3880e02285dc2406e20249c948401c0009901040019389dc806c111662cb142e0c18651935321b324d18138284b82518018514304ec3b62c9a0869121304ca3842122951424201dc1650c140319cb00cc3084813098ac0b88998a6109c046d0c27298c948d20408ee3b825d8004164422084408052420d18a90562066a9b144681108064926c00289053a049242045a314129a2628d216610921820cc245a202658418081a07265b906cc944028828268488690cc18599c00c4436600b432ce12211e2a6299c18520398714ab88d1c49840a836d59040c8cc62d18498d24104520360dda08500210401c340991086e4b3805a330811831125b362014074a14a2248a128e0188508a14501805840ac55162342e80264a41848882262c01c5895302801bc329044264da242e82380504186849a8898c402aca8430e0048a8a2849e138294a1004c39070d3c641c8003142906d5a0285cc22491c22849402925ac65153268103a480642448dbb0812203321028299c12201c8501e0062283c82961b805e1b44442c00c14112591441119384642488a00032ed2040954924518118e0c90600cc98413324010319124059009214e09116500948904174cda22859c844003380d61888881b280022708a4c68801342410380102928cd1c431ca187143c651c0106a0a2701c0244d89068d8396294c106119982cd902424494910ca30511c101d3424900b2089c8050c4a2118a2228c4a08808938c020572621064c33220c4a60d19980150a22952880109a32801350cca280dca80018b0028249528da98055bb08d100110043866cc444e1a496c203205cc42651a8725e2221050a291c4a46d99020219044021a06813b01099b28c24172e01437211b94019a04153845190426414268680482d03814c91224a4a30889314201c080491b20da3b22908a468144790da4608d0043124c84c4210214b382cc98491912462439060d028bf6be7c4cb98214522bfb7d9b6f4aaca9db9f5682be7786727a240d486b92fb5f4003af9427278df44da48c0875d6b3846126d77d973953fcbdd5a6cd1d17fc5d9fb598f469fb651123322127b2ed518dbfc5417f79461e4c21fde0adcba247d09f695256f27a6d77b6e11386439fb5a0da6bce036f3fcd013e3f6e71f1d5718c5eaf41d5633eb66bfb0ecc227c8a07c2c13047e697b5252eb2799247a4595a281d741ee66a1a60f21b381d06d21940b53fa7015306e9646c553516f11df805d97d95eb689e7851e4e16e2282e2394269d69555e9380fe2fb884acab64f3dfb5b50f4a1d0667bb6082e920b99afb76e2b625551c11d8f813c8a1ddd320305ba4c4f257aa9fef04d3986280064e44b6937e2eb3f6e61ee742b5e6d607937b3d04c1ec4f2ec8df640fe5ab5200517547d44b01c6cf9d0e234dd14d3c8abe059cd6020b575ca6355f7ae84be7c3e66fd891c6cc6a2f8b77cc047e3aed7a784186cc3f42af7ba42c2159f9bdd03e2de9c95428ad1a1dc73b7ab95bee1f01c255f5611b63e7ea8492e1cf6e5c66e490e69cde65578c24d8f0d6b78b79066322304f985759d28948ac6ebe94da50ac7b95813af76e855268b154fbd268d566c9ae63c6c6be4f7a6dddf70049acc8cb2563b29c1ece13c380e41575f8952154d6447b3ae0a19f088f28edb565b8290672ac079cae9bf0142e203550b1776b7d6c2f44c5f3dc6354be0d0230c481a65c73b087eac2f216cef47fda8c57dc6aa4af210abcecb3c6ecae5f76e4fdb8a7cfbe22437158d299afb5387b243cbdf2f1e079cb136dab1dfc5b0406e3d654ef5f2ee7ae3f5647d5f87e573247f9076b92a94b102fb9c8320ff23b38f65e05be147d88657e461c7171ff4c67ea6889e52f86fb1fdcf03dafdd6c7faa09033ae0ae274853c261b9bdbf20c2848d587a8d7b34526c46bb376edc5d0a7b01aeab68bff4fccb9002bc6d8da4c53b8668c12564905b95548a5a1abb1d804c74e14631b7cf4346d0a0876fa55f9dbeefa4da683c4421d6772447cf00da695769fe99651cb30bb28b6a100b1c26a684fef88cd116b8b6383e587d500af4dc9b2f65c23ebcb9dee5888af2df0562929c6c1a89edf822bad37814d311e70021d8d21bd3f6d4fa2ad8d84593256c92c166b71d85bb5ecf4d035b9727fba1d860fec05673ac616a2392001fb38b805a3eb5486bc430c8084edddd24d0eb3a8233859920d88830c6cc285b6536e8dc9b4e0a612fba15e86f4a495aba17c23f22b82bde486ce613eacfd01ad3ecb9b8c80f11e21cef05c7cfa3d9da5504d7d123333950db6ab1e8783002ee4744c4e7e30e370f30e9c310b97c4a49d8ef636ea16371a69270e8b42a03a351cc5f2369384a393d63ffb752ef47fa0c6f28365012beedad1fd9da4e0a9d03b55b7130e893b5a4bb6594dafc9e5283d26c603fa193c20b002ae5eb3288ba37e42e2418a5dc4548a2b8a9cc2e0b53e165df5a46b237752ff7c9912312fd9b3220bf89ddf42522ee2cfe12a505a5bc6e08c87597c37f21444254ffcb639147c489c6df6d87a4d018bf7dcbc21132b87c43f4b9835f46f6172dfac4e6987e6d35920ce548291867370c5fc9a87a844b4186df1ba0964e9dd79f16a6db45c78fca3a7a1e0779ee030ccc2f87d1d982454cdc8290b27344f98ad815dd93a4039b37f19de816e2308094bc3dfa566ed5918cc0301e34836a7006ab34b9bee5a7b74b7fa6ebbd141db81d3825bc8721217425ffe88f9661abc0e642f9ee12fead70359a908583ce09764b7ff0239e2c544c4b671022bfb0fb019fc380ecad8308930984bfc24537278583406258d6977f3e06b556af703c488aadb9bedb43a6aae2d8a61e611b2f810c8007c8bf75e97b4f24d8e612afabb04f2da1a7129d4f88d13883da47af7200a97a30a421a7492abe64d039d68056b0268d08eb16b2432186230bb6df8429d26c76ca20a7810d1c6812c4abce516d349ab41039313225490af48efb8d9266329cd2863c6cec87e82a6c6cf3b9f75c026d6c444e11a0d7dd29b5024af29099c6883c86134a34b05fab04bac76d00b3067323948fbf4bcc6f16159fd1ae8818c975346388d2d7341f8dea37e0dc27fbb9ff6b1f353b8dbe08b230e4efd010ec13a32a3856f5b2a16706d5e62b0fae27ee67880e4a0240d64716436036c4ef4716af27e8114e3e59c68938bd095baf5f9db71d7c5f5c12c97a7ab2171be79b5d9154a37c799d4fdd9c5391655fd605e51f4a3aab06a91443fe697d421310e621b12040daeee392e30fc36040f1acd43eea3e2abe7b2cf5b21c3963a70e86e93320cba25093e33e94dfdc").unwrap(), "sk not correct");
    assert_eq!(sig, *hex::decode("8205ab20fbafe5ba3032ac9b5922d10e5a0364ed6181f4148f9005c3598990db75b773dc1002cf8c3d2608eb250abdf7615a2334d36581c9a366395d713d0d3d37dde879eeb82694b6bb1f42123ea0b8d37415e7aca9233db7478d7500359546ca8b05432c6f4e113051e0a08084b001ed81497d0616404238e0716b1975bd0b8a52351f161cb8acb67014d0a776241912e881adeff1900588edd1669adada713023f4ab7c0390814b71b97f735270683eab2567e49843de68098710f486b839ea53e5c9b235666ed753cfbb79d1a6ed977043b8859e89a7b55bc02700b3cf02798a3567fb44488e0e96f92362f2187818bdc58600fa374d129aa7dee11554bc4482206c4f2badf6946bab08ece72f6d603c158d8b80619d00c97185d7e2d79f085cb12bc15101bb24e3b667a52fa9f0748be67f483fceff66c3fcac4a7962bf291a1ab3755dbf1d346da0aea95e458361d0a552131cf22958659afcdc9da4f66633ab1bd1217b8f29e3b96a870afa225ef2e4b1e56760e45951d016f1be4b8bf2745573d63aaefab2cc8ca159445de71d6033ecd5b5f0226e894f4425e6ecdcf5511a0a5f57944880d7c918f8751e1e58c13d5dcda9a5e161a4912080e48fcb7f7427f260c2040bbc5b6b5bfd69e221aeefca0667a83f63977d781784018e712993303e1741e705e85382f065908655ea570d24e4337c35c2c9a2a39d01c7e0ce9e4d4ab5453bfe7e1109b100ccf79d1e78f00e136bc9f5a2bf9ed79d585d9a486e5c6f9ec2d2a2253a6b5abfa012b394449b430ef79b6d136a29057e643a89f651aa3c615a1b06eb4037b2e02c5e6900acb6502ba96959caf02edaf5c889e7b46775f6712672eb7369eff45b972e892176214ef3665102b99e1a1ebbd7aa2ca7989255dd114939b9f47bcc8e77140a69cce800fdc26e1e7620de0b5dff277a5b0cf0103340a377b40afeea139d22ee79b826c9eddf98433f186011204494def86be84787190eb57762c618c0a2de1d8b23fdd54fc3365d24c1eee9bce996b974db749ed5c3ff94e24124e408c0427c9a9a389ce6dbaa7e4dde3c0f108ac13f86db9cdbbf3f4cab5ad9ec5017c89e07f76f5e2af51112dd8e5de40a39068e47dc9192ee6078eb54990fc1025353082315aa6f8d339c578db694de8e2e0f92dbcbc44d2d1da8b75c50ba88a8fc050388bc067dc7c3a9c709c4f00d37b1bf22e0b0641a2b086af4b58e59863cbdb5c365765d779de0ea385b38d3840b22b5b989c35f9103631e851b8c66504235ccc711d86c240c8c60823ea0b31c41a065ad22e59887a8609c9fc9ec227802fddec6ef83c5ce7da63a85bc1bee62c18d0694be098839c91f0ab4fb723983867687b1c6c070e49a247cd48a04be39df2af40272eb8f621d5a520075fd05bf8ed5fb66f76e75e74cea3490be2a8e2cd430a300a14e90d7a84a58b5f395dc0e45122c0a3f37efa1c811fad7efeb43baaadb1a2d609d076ddb430ab0e18b5572686f22c8ca4d743b0de07cd737a555a907cc7477c525711f0db13e60f86dbbda17e0d2e8c6cf9951a5857fbaad4e6a165cec3ff81f69ce4d988196dcdafeb2878d329fcb6b10cc335aabd122a2017534ebc8039636a66d2bb209d29d9480a7a651a99d8ef1a125955f363d9274b507772636671e1fd77afa761db1923b7b8de675bf30cf782d7943a2979250913230b507c6f734e57fa0c917238e0ec02d11fadca4f0725662c83e3b21b47958cf1ff41e73d87de0d211dad13f5621b0f84301432affba0f1933ecdebd97487dccd3c0a258b03439f8942be8ef4800f5ffc6dc36b2bc043f992e673c0822459f181310833a1243f0bae3ad408b6800198dd06ea39364071968e22a30b579ecba74a1e901728f24631724febbe7d68c788ca019d9271927d0f8043670f210d7f37da2886d23e91bcd0db107f5e7a95b69cff2dda5329e29e3923d3d3f19dac89b179ec90d638ef97e2523903055aedb3a1773c49d17407a71cb326c7b5b28a3ee3d23d36e63b0a9e74819a1870000128d081cbf412c3cef96fda35a7eeadf34a03d3e1fdfa335dc8f1f4739a4262630c30fadf394104081122eab22fdb57fe4ad24a6c3516260557e28546405ac7cff361f38b5bc07ab5b81377e9e34d5500d3816fe002d19262579a0fbd058f8a2cf0c9984d6c3bef99403c0a286a86ec01809346a9e3d48a5c2029bbb7e756c1187f9e9ec72e8f37c01bbec3c75435bad088c21d8b93f210c7a0c3a3607f4e2267d31fa0a74302daede73f1d304d79bcd4e9b91a1223806dde9b73405fd67ff8e1b76702cab55b669c8a4ecd5ef57147324bd9c207638d4261bf123165d45ac6b4974ae7cf13fe3868327d903c9c9a79b8004520855ec9cd05dbf2d9b56fe7f83ab87c94e15b297de13e2b66b56d8d952dd665e70b3a2d07f5a1fe1467e30f7b1f574e1376f4fc9c5bec6af9cd72e0b485800b34112811aa28cd3ea11fc6136941584c1488105513c100679472f8e1f5cc111d82c66c1c5242e471459f6bd7ca80a2152c64d46752d92ab37fa4f0c3b85a7238714b1ca7962506e3c42ca9233118728477441f9fe2bc2dfe5e9a709231b6417ac3de9cebf42acc26a607d003d890c3fff482baac070a98e78d47042e04d70b75b629daa38c1c9d826feb8ed377febb2d418ab1d81fd1811003476e39a27badc32275aa028d74a7de5791cd72b0eb4ca6b84f12f18ffdaba0baede94038c99ca7f65b1c1c7d6cbcd3fd7829f5a3dc0181e6f0116aea1f028adace2721d7366840849a41fa37051ac935e8385a90cb6f10a1fe08ad13452e6d96649c61fafa22e99272a1a24bcf57f26409cffc663b0db0277d3911f33aabff791b09bc4af8264e6a070c30d96808c2360681e5b67d79a99745ca63469f9bc9870f7e86a1ea695092e9f0c054787baeee5b9251495e1eae391490b44e5132bdd5b84291cc100ea7061f72de07fe5e4c6ac18dbbcf50a2fe0b2a10b54566e7ac29d94d9ba4d7a69596ecfcfe9f3b73ecddc71396207b7c42b1aa4555ac1855ee444ee10cfb570b86842e3cc30eb9a3a4e3284921b9c506566627743f83bd80798dd3725a3c079768e715223b5f5fca913df9c57def810a26ec17c30371dbe22f312da22e63085f28f93fffd520b30e60d0d9ead7a9f7e03e9e2c099fd3a6438d8bfdad3311a0631cb724e53ccd13fb558cbeaa7893f324dc4d0e65699c528dc5255d58f686e1d1f3a2255921cce965c48fea41aaf627d343679ef59b7d47ea1bac2745767fac686681742b9352cdc3c19222c3c405053555862696b99b8ceddf4f7345e73768fa2b0b2d7f5f8ff3d4d5567686e7ca0a7bcc1c5d7dde901050a141d2d3e44484c59626c6d9093a8becaedf5fd00000000000000000000000000121e2d43").unwrap(), "sig not correct");
    assert_eq!(pk.into_bytes(), *hex::decode("e1d8a883b4f9cadb6ec2878ab505a80fae74f653c865fd8f65e81b04567282d2a0a386744fbbf0eae28e0f6116f0fba5fb006b0456c3bc401cf431fe72e2585dd15ff0cd11840efa6ffcda2eb33c1fcc698f6082b2d5902e8c760ab51414432035aa2aef3c5d1821175c6f52552b15957bfd37f17caf123cdb2bee49e5fa1009415ff25b3924c80244ec92999d75bbcda6695d12689038d1562a7367b83f4d1bfc115f9ea6b5312019b42cb35f14c4cbc42c4426ba214d659f5b0438da21dc50302654f3b5c6fe8765da736d25f9c3051e8b2be62f4f7dc78f55376f674f468bad69a063058f9b3a602d40d9042d9c554a813a673c5902d5c4f5a6f5844b8d2ea7373dbdba2f6000d561fb960e50883741c96b74667fb50aeae4bfa9b68322d57fbe83ea1257f9d927e8b491c24b4f4d4314d32bbb42446198158650ea2e35d20f71bc27c5dc30f30893596740e6668912a8ad0e2046e18cd79b3232d140954c4ed7921fd693efc554aa52011cb5a1e9cd510f724c8fc3fd6589d2effa5d962d0658c37ab1634990a8599baeff5962dbce6688904fbe64b61e86c3f96b7943ab33d618dc53590e7fdf97055f152c41f27bdf16564b9e21b686cbbdd4b02e37da65929c800cc586f0f087e059f7ff1c8062d66be9f6c52d5a9316a985cc33adddb13b31791681af833ac0c4c86cee5e89ccfbb2957f7b15beb4c99aca440d1f19119a613a87d899d558fadfef4b3abd6884c3295d753e4559131e1e7a518b0a75c393b1b11fc8b19f39be979d21f15e094bb36173630bb5e4697458b18a0f8d9c8bac8213ba32ca515464cfd41c8c1e67a097600dcb5d38cfb0f8bb52dc9d4c1919537dc0b4ee0af9f8fcf7d9c225bb16b7e4b5decd2606213b58a2f012fd5d414bcc8311847f8fd48520e4a7d934b1262f4ae9d8a233088b7e08707a1d80e6c8ea42a8096f88c6cd4f9eb75aae2751e0a31b0ac6dfa57605ac4b1da0b18338e69742852137d3b04e164f31dbc817f86c31f651716ee521b595a5c9536c91e12e80a4cd5c57769b2eb77469fcb79aeceae8e997b2e9ad98b5cacf310257280d61e764cd8e2baf7f67b6c0f8e7affc92ea3464d185beef7e5fb4f4d8a8da70640e94f76942f1b39dd8e72567439d92a95173ebeec3b9dc0d0ea8e7be42b24564bd1a3b618372ff012302ad06e279def6ae64f0081d095b8b32cf1608a8b5c84bc81a4e4eea00360536efb5803fd0a861c791588ead9256d486d5518660748e9d64262f7f87a742e23c534fe9c2ac6cba5621a8c8e9cd95bff3eb893d043076c09992aa87a4fadca5765b3142e88ac9693960b6a91b2b97ed11d99231345451eac326316cb8236c715f41b89c65198b7fe0cd38f006531d551a7bd8b7575af4d9839878db8c034ddd73e5ac25792c45123236ed86c37b829e6dec5c945e20a3c08f9f25375771429c28ebfe182c3de6dfdef77640e54004eaeda663ee84643e39b0401b10fa57fff31b8ed0a61f64d1b96b7b95c7e65bcf01ad1be783a3d901588663785a1b52ca2f993eaa5144d36fa93feb0fa3012c835312e32e4669b12a15d37ebd68f6c3c9be5b3364a86a5d77afa27ae68022b32c74d2d878fcb0634e506a27d1ed26c53c0e678e9023a4d20d53ee344bef98c3a94fc384df75c9c55d67238e2143bba44414818a167580af88504218680bee310b13ed0409e155e941c59c056ef4334ef255aed2dd29c5cc74d2e4db0c4cbfd7bcb0d65d2a7eac360f878a159220d35e4c1a069eb8d5caa13974729f28c60d0ef183fc1f5e13dc28e98b98f82baa610a957441af4a055027080856a816e796f42d04eadb0f490ac89af03e").unwrap(), "pk not correct");
}

#[test]
fn test_two_peer() {
    let message = [0u8, 1, 2, 3, 4, 5, 6, 7];

    // Generate key pair and signature
    let (pk1, sk) = MlDsa44::try_keygen().unwrap(); // Generate both public and secret keys
    let sig = sk.try_sign(&message, &[]).unwrap(); // Use the secret key to generate a message signature

    // Serialize then send the public key, message and signature
    let (pk_send, msg_send, sig_send) = (pk1.into_bytes(), message, sig);
    let (pk_recv, msg_recv, sig_recv) = (pk_send, msg_send, sig_send);

    // Deserialize the public key and signature, then verify the message
    let pk2 = <MlDsa44 as KeyGen>::PublicKey::try_from_bytes(&pk_recv).unwrap();
    let v = pk2.verify(&msg_recv, &sig_recv, &[]); // Use the public to verify message signature
    assert!(v);
}
